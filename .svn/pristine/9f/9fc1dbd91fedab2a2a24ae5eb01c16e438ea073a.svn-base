{"version":3,"sources":["assets\\Script\\GameRankingList.js"],"names":["cc","Class","Component","properties","rankingScrollView","ScrollView","scrollViewContent","Node","selfRankItem","prefabRankItem","Prefab","prefabGameOverRank","gameOverRankNode","gameOverRankLayout","loadingLabel","iconSpriteFrame","type","SpriteFrame","onLoad","removeChild","CC_WECHATGAME","window","wx","onMessage","data","console","log","messageType","fetchFriendData","node","active","removeAllChildren","getComponent","Label","string","getUserInfo","openIdList","success","userRes","userData","getFriendCloudStorage","keyList","res","sort","a","b","KVDataList","length","JSON","parse","value","score","i","playerInfo","item","instantiate","init","addChild","avatarUrl","undefined","level","getChildByName","Sprite","spriteFrame","layout","Layout","resizeMode","ResizeMode","NONE","fail"],"mappings":"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","sourceRoot":"/","sourcesContent":["cc.Class({\n    extends: cc.Component,\n\n    properties: {\n        rankingScrollView: cc.ScrollView,\n        scrollViewContent: cc.Node,\n        selfRankItem: cc.Node,\n        prefabRankItem: cc.Prefab,\n        prefabGameOverRank: cc.Prefab,\n        gameOverRankNode: cc.Node,\n        gameOverRankLayout: cc.Node,\n        loadingLabel: cc.Node,//加载文字\n\n        iconSpriteFrame: {\n            default: [],\n            type: cc.SpriteFrame\n        },\n    },\n\n    onLoad() {\n        this.removeChild();\n\n        this.CC_WECHATGAME = true;\n        if (this.CC_WECHATGAME) {\n            window.wx.onMessage(data => {\n                console.log(\"接收主域发来消息：\", data);\n\n                if (data.messageType == 0) {//移除排行榜\n                    this.removeChild();\n                }\n                else if (data.messageType == 1) {//获取好友排行榜\n                    this.fetchFriendData();\n                }\n            });\n        }\n    },\n\n    removeChild() {\n        this.rankingScrollView.node.active = false;\n        this.scrollViewContent.removeAllChildren();\n        this.gameOverRankNode.active = false;\n        this.gameOverRankLayout.removeAllChildren();\n        this.loadingLabel.getComponent(cc.Label).string = \"玩命加载中...\";\n        this.loadingLabel.active = true;\n    },\n\n    fetchFriendData() {\n        this.removeChild();\n        this.rankingScrollView.node.active = true;\n        if (this.CC_WECHATGAME) {\n            wx.getUserInfo({\n                openIdList: ['selfOpenId'],\n                success: (userRes) => {\n                    this.loadingLabel.active = false;\n                    console.log('success', userRes.data)\n                    let userData = userRes.data[0];\n                    //取出所有好友数据\n                    wx.getFriendCloudStorage({\n                        keyList: [\"nuoduidui\"],\n                        success: res => {\n                            console.log(\"wx.getFriendCloudStorage success\", res);\n                            let data = res.data;\n                            data.sort((a, b) => {\n                                if (a.KVDataList.length == 0 && b.KVDataList.length == 0) {\n                                    return 0;\n                                }\n                                if (a.KVDataList.length == 0) {\n                                    return 1;\n                                }\n                                if (b.KVDataList.length == 0) {\n                                    return -1;\n                                }\n                                return JSON.parse(b.KVDataList[0].value).score - JSON.parse(a.KVDataList[0].value).score;\n                            });\n\n                            this.scrollViewContent.removeAllChildren();\n                            for (let i = 0; i < data.length; i++) {\n                                let playerInfo = data[i];\n                                let item = cc.instantiate(this.prefabRankItem);\n                                item.getComponent('RankItem').init(i, playerInfo);\n                                this.scrollViewContent.addChild(item);\n\n                                this.selfRankItem.active = true;\n                                if (data[i].avatarUrl == userData.avatarUrl) {\n                                    let score = 0;\n                                    if (playerInfo.KVDataList.length != 0) {\n                                        if (JSON.parse(playerInfo.KVDataList[0].value).score == undefined) {\n                                            score = 0;\n                                        }\n                                        else {\n                                            score = JSON.parse(playerInfo.KVDataList[0].value).score;\n                                        }\n                                    }\n                                    else {\n                                        score = 0;\n                                    }\n                                    let level = 0;\n                                    if (playerInfo.KVDataList.length != 0) {\n                                        if (JSON.parse(playerInfo.KVDataList[0].value).level == undefined) {\n                                            level = 0;\n                                        }\n                                        else {\n                                            level = JSON.parse(playerInfo.KVDataList[0].value).level;\n                                        }\n                                    }\n                                    else {\n                                        level = 0;\n                                    }\n\n                                    if (i < 3) {\n                                        this.selfRankItem.getChildByName(\"img_rank1\").active = true;\n                                        this.selfRankItem.getChildByName(\"img_rank1\").getComponent(cc.Sprite).spriteFrame = this.iconSpriteFrame[i];\n                                        this.selfRankItem.getChildByName(\"rank\").active = false;\n                                    }\n                                    else {\n                                        this.selfRankItem.getChildByName(\"img_rank1\").active = false;\n                                        this.selfRankItem.getChildByName(\"rank\").active = true;\n                                        this.selfRankItem.getChildByName(\"rank\").getComponent(cc.Label).string = 0 == i ? \"100+\" : (i + 1) + \"\";\n                                    }\n\n                                    this.selfRankItem.getChildByName(\"score\").getComponent(cc.Label).string = score + \"[\" + level +\"]\";\n                                    this.selfRankItem.getChildByName(\"level\").getComponent(cc.Label).string = \"第\" + level + \"关\";\n                                }\n                            }\n                            if (data.length <= 8) {\n                                let layout = this.scrollViewContent.getComponent(cc.Layout);\n                                layout.resizeMode = cc.Layout.ResizeMode.NONE;\n                            }\n                        },\n                        fail: res => {\n                            console.log(\"wx.getFriendCloudStorage fail\", res);\n                            // this.selfRankItem.active = false;\n                            this.loadingLabel.getComponent(cc.Label).string = \"好友排名未授权，无法查看\";\n                        },\n                    });\n                },\n                fail: (res) => {\n                    console.log(\"wx.getFriendCloudStorage2 fail\", res);\n                    // this.selfRankItem.active = false;\n                    this.loadingLabel.getComponent(cc.Label).string = \"好友排名未授权，无法查看\";\n                }\n            });\n        }\n    },\n});\n"]}