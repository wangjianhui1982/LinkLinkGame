{"version":3,"sources":["assets\\Script\\GameRankingList.js"],"names":["cc","Class","Component","properties","rankingScrollView","ScrollView","scrollViewContent","Node","selfRankItem","prefabRankItem","Prefab","prefabGameOverRank","gameOverRankNode","gameOverRankLayout","loadingLabel","iconSpriteFrame","type","SpriteFrame","onLoad","removeChild","CC_WECHATGAME","window","wx","onMessage","data","console","log","messageType","fetchFriendData","gameOverRank","node","active","removeAllChildren","getComponent","Label","string","getUserInfo","openIdList","success","userRes","userData","getFriendCloudStorage","keyList","res","sort","a","b","KVDataList","length","value","i","playerInfo","item","instantiate","init","addChild","avatarUrl","grade","getChildByName","Sprite","spriteFrame","toString","layout","Layout","resizeMode","ResizeMode","NONE","fail","userItem"],"mappings":"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","sourceRoot":"/","sourcesContent":["cc.Class({\n    extends: cc.Component,\n\n    properties: {\n        rankingScrollView: cc.ScrollView,\n        scrollViewContent: cc.Node,\n        selfRankItem: cc.Node,\n        prefabRankItem: cc.Prefab,\n        prefabGameOverRank: cc.Prefab,\n        gameOverRankNode: cc.Node,\n        gameOverRankLayout: cc.Node,\n        loadingLabel: cc.Node,//加载文字\n\n        iconSpriteFrame: {\n            default: [],\n            type: cc.SpriteFrame\n        },\n    },\n\n    onLoad() {\n        this.removeChild();\n\n        this.CC_WECHATGAME = true;\n        if (this.CC_WECHATGAME) {\n            window.wx.onMessage(data => {\n                console.log(\"接收主域发来消息：\", data);\n\n                if (data.messageType == 0) {//移除排行榜\n                    this.removeChild();\n                } \n                else if (data.messageType == 1) {//获取好友排行榜\n                    this.fetchFriendData();\n                }\n                else if (data.messageType == 4) {//获取好友排行榜横向排列展示模式\n                    this.gameOverRank();\n                } \n            });\n        }\n    },\n\n    removeChild() {\n        this.rankingScrollView.node.active = false;\n        this.scrollViewContent.removeAllChildren();\n        this.gameOverRankNode.active = false;\n        this.gameOverRankLayout.removeAllChildren();\n        this.loadingLabel.getComponent(cc.Label).string = \"玩命加载中...\";\n        this.loadingLabel.active = true;\n    },\n\n    fetchFriendData() {\n        this.removeChild();\n        this.rankingScrollView.node.active = true;\n        if (this.CC_WECHATGAME) {\n            wx.getUserInfo({\n                openIdList: ['selfOpenId'],\n                success: (userRes) => {\n                    this.loadingLabel.active = false;\n                    console.log('success', userRes.data)\n                    let userData = userRes.data[0];\n                    //取出所有好友数据\n                    wx.getFriendCloudStorage({\n                        keyList: [\"nuoduidui\"],\n                        success: res => {\n                            console.log(\"wx.getFriendCloudStorage success\", res);\n                            let data = res.data;\n                            data.sort((a, b) => {\n                                if (a.KVDataList.length == 0 && b.KVDataList.length == 0) {\n                                    return 0;\n                                }\n                                if (a.KVDataList.length == 0) {\n                                    return 1;\n                                }\n                                if (b.KVDataList.length == 0) {\n                                    return -1;\n                                }\n                                return b.KVDataList[0].value - a.KVDataList[0].value;\n                            });\n\n                            this.scrollViewContent.removeAllChildren();\n                            for (let i = 0; i < data.length; i++) {\n                                let playerInfo = data[i];\n                                let item = cc.instantiate(this.prefabRankItem);\n                                item.getComponent('RankItem').init(i, playerInfo);\n                                this.scrollViewContent.addChild(item);\n\n                                this.selfRankItem.active = true;\n                                if (data[i].avatarUrl == userData.avatarUrl) {\n\n                                    let grade = playerInfo.KVDataList.length != 0 ? playerInfo.KVDataList[0].value : 0;\n\n                                    if (i < 3) {\n                                        this.selfRankItem.getChildByName(\"img_rank1\").active = true;\n                                        this.selfRankItem.getChildByName(\"img_rank1\").getComponent(cc.Sprite).spriteFrame = this.iconSpriteFrame[i];\n                                        this.selfRankItem.getChildByName(\"rank\").active = false;\n                                    }\n                                    else {\n                                        this.selfRankItem.getChildByName(\"img_rank1\").active = false;\n                                        this.selfRankItem.getChildByName(\"rank\").active = true;\n                                        this.selfRankItem.getChildByName(\"rank\").getComponent(cc.Label).string = 0 == i ? \"100+\" : (i + 1) + \"\";\n                                    }\n\n                                    this.selfRankItem.getChildByName(\"score\").getComponent(cc.Label).string = grade.toString();\n                                }\n                            }\n                            if (data.length <= 8) {\n                                let layout = this.scrollViewContent.getComponent(cc.Layout);\n                                layout.resizeMode = cc.Layout.ResizeMode.NONE;\n                            }\n                        },\n                        fail: res => {\n                            console.log(\"wx.getFriendCloudStorage fail\", res);\n                            // this.selfRankItem.active = false;\n                            this.loadingLabel.getComponent(cc.Label).string = \"好友排名未授权，无法查看\";\n                        },\n                    });\n                },\n                fail: (res) => {\n                    console.log(\"wx.getFriendCloudStorage2 fail\", res);\n                    // this.selfRankItem.active = false;\n                    this.loadingLabel.getComponent(cc.Label).string = \"好友排名未授权，无法查看\";\n                }\n            });\n        }\n    },\n\n    gameOverRank() {\n        this.removeChild();\n        this.gameOverRankNode.active = true;\n        if (this.CC_WECHATGAME) {\n            wx.getUserInfo({\n                openIdList: ['selfOpenId'],\n                success: (userRes) => {\n                    this.loadingLabel.active = false;\n\n                    console.log('success', userRes.data)\n                    let userData = userRes.data[0];\n                    //取出所有好友数据\n                    wx.getFriendCloudStorage({\n                        keyList: [\"nuoduidui\"],\n                        success: res => {\n                            console.log(\"wx.getFriendCloudStorage success\", res);\n                            let data = res.data;\n                            data.sort((a, b) => {\n                                if (a.KVDataList.length == 0 && b.KVDataList.length == 0) {\n                                    return 0;\n                                }\n                                if (a.KVDataList.length == 0) {\n                                    return 1;\n                                }\n                                if (b.KVDataList.length == 0) {\n                                    return -1;\n                                }\n                                return b.KVDataList[0].value - a.KVDataList[0].value;\n                            });\n\n                            this.gameOverRankLayout.removeAllChildren();\n                            for (let i = 0; i < data.length; i++) {\n                                let playerInfo = data[i];\n                                let userItem = cc.instantiate(this.prefabGameOverRank);\n                                userItem.getComponent('GameOverRank').init(i, playerInfo);\n                                this.gameOverRankLayout.addChild(userItem);\n                            }\n\n                        },\n                        fail: res => {\n                            console.log(\"wx.getFriendCloudStorage fail\", res);\n                            this.gameOverRankNode.active = false;\n                            this.loadingLabel.getComponent(cc.Label).string = \"好友排名未授权，无法查看\";\n                        },\n                    });\n                },\n                fail: (res) => {\n                    console.log(\"wx.getFriendCloudStorage2 fail\", res);\n                    this.gameOverRankNode.active = false;\n                    this.loadingLabel.getComponent(cc.Label).string = \"好友排名未授权，无法查看\";\n                }\n            });\n        }\n    },\n});\n"]}